# Manki DB

## 0. はじめに

### 0.1. 使用したデータベースについて

本開発ではデータベース管理システムとして mysql を使用した。

以下、[公式のドキュメント](https://dev.mysql.com/)を引用しつつ、本開発で作成したデータベースについて述べる。

### 0.2. テーブル定義について

#### 0.2.1. Type について

Type とは データベースに登録するデータの型を指す。ここでは本開発で使用する型について説明する。

##### 0.2.1.1. varbinary 型

varbinary 型にはバイト文字列データが格納される。( ) 内の数値はバイト長を示す。

今回 varbinary 型を登録するカラムは、文字列 UUID をバイナリ UUID に変換にしたもののみであり、その時の返り値が varbinary(16) であるためそのような型定義になっている。UUID については後述する。

##### 0.2.1.2. varchar 型

varchar 型には可変長の文字列データが格納される。今回この型を持つカラムは、ユーザからの入力を受けるカラムである。

##### 0.2.1.3. datetime 型

datetime 型には日付と時間の両方の部分を含む日時データが格納される。形式は _`YYYY-MM-DD hh:mm:ss`_ である。今回 datatime 型を扱うカラムは mysql で定義されている _`NOW()`_ 関数を利用している。

##### 0.2.1.4. json 型

json 型には JSON (JavaScript Object Notation) データが格納される。今回 json 型を扱うカラムには経路・地点データが格納されている。

最大格納サイズはデータベースの max_allowed_packet に依存、本システムでは 67 MB まで。

##### 0.2.1.5. bigint 型

bigint 型には整数の数値データ ( 8byte )が格納され、負数込みの場合は _`-2^63 ~ 2^63 -1`_ まで、非負数の場合は _`0 ~ 2^64 -1`_ までのデータが格納できる。

今回 bigint 型を扱うカラムは非負整数のみを扱うため、_`bigint unsigned`_ としている。

##### 0.2.1.6. tinyint 型

tinyint 型には整数の数値データ ( 1byte )が格納され、負数込みの場合は _`-128 ~ 127`_ まで、非負数の場合は _`0 ~ 255`_ までのデータが格納できる。

なお、今回 Type 定義が tinyint(1) のカラムは boolean 型が変換されたものである。

##### 0.2.1.7 double 型

double 型には概数値データ ( 8byte ) が格納されます。今回この型を持つカラムは、地点データの緯度または経度を格納しています。

#### 0.2.2. NULL について

NULL 項目が YES であればそのカラムのレコードに NULL が許容され、NO であれば許容されない。

#### 0.2.3. Key について

Key はカラムがインデックス付けされているかどうかを示す。Key の値には PRI 、UNI、MUL の 3 種があり、1 つのカラムに対して複数の Key 値が適用される場合は PRI、UNI、MUL の順で優先順位が決まっており、より優先順位の高い Key 値 1 つが表示される。今回は PRI と MUL を使用するため、その 2 つについて述べる。

##### 0.2.3.1. Key : PRI について

Key に PRI と表記されているカラムはそのテーブルの主キーである。

> `Key` が `PRI` の場合、このカラムは `PRIMARY KEY` であるか、またはマルチカラム `PRIMARY KEY` 内のいずれかのカラムです。
>
> [MySQL 8.0 リファレンスマニュアル より引用](https://dev.mysql.com/doc/refman/8.0/ja/show-columns.html)

##### 0.2.3.2. Key : MUL について

Key に MUL と表記されているカラムは、今回は外部キーが設定されているカラムのことである。外部キーには "インデックス" が必要であり、"インデックスが重複して現れるカラム" であるから MUL 表記になっている。

> `Key` が `MUL` の場合、このカラムは、特定の値がカラム内に複数回現れることが許可されている一意でないインデックスの最初のカラムです。
>
> [MySQL 8.0 リファレンスマニュアル より引用](https://dev.mysql.com/doc/refman/8.0/ja/show-columns.html)

#### 0.2.4. Default について

> データ型指定には、明示的または暗黙的なデフォルト値を指定できます。
> [MySQL 8.0 リファレンスマニュアル より引用](https://dev.mysql.com/doc/refman/8.0/ja/data-type-defaults.html)

デフォルト値には定数や NULL、関数などが指定でき、それらを使用している。

以下に、Default 値に使用した関数を示す。

##### 0.2.4.1 `UUID()`

> RFC 4122, **「**「汎用一意の IDentifier (UUID) URN ネームスペース」**」** ([http://www.ietf.org/rfc/rfc4122.txt](http://www.ietf.org/rfc/rfc4122.txt)) に従って生成された Universal Unique Identifier (UUID) を返します。
>
> UUID は、空間と時間においてグローバルに一意の数字として設計されています。 これらのコールが相互に接続されていない 2 つの別々のデバイスで実行された場合でも、`UUID()` への 2 つのコールでは 2 つの異なる値が生成されることが予想されます。
>
> > 警告
> >
> > `UUID()` 値の目的は一意性を保つことですが、必ずしも推測不可能または予測不可能であるとはかぎりません。 予測不可能性が必要である場合は、UUID 値を何か別の方法で生成してください。
>
> [MySQL 8.0 リファレンスマニュアル より引用](https://dev.mysql.com/doc/refman/8.0/ja/miscellaneous-functions.html#function_uuid)

今回の開発では、一意性を保つために UUID を使用している。

##### 0.2.4.2 `UUID_TO_BIN()`

> 文字列 UUID をバイナリ UUID に変換し、結果を返します。 (`IS_UUID()` 関数の説明には、許可されている文字列 UUID 形式がリストされます。) 戻りバイナリ UUID は `VARBINARY(16)` 値です。 UUID 引数が `NULL` の場合、戻り値は `NULL` です。 無効な引数がある場合は、エラーが発生します。
>
> `UUID_TO_BIN()` は、次のいずれかまたは 2 つの引数を取ります:
>
> - 1 つの引数形式は、文字列 UUID 値を取ります。 バイナリ結果は、文字列引数と同じ順序になります。
> - 2 つの引数形式は、文字列 UUID 値とフラグ値を取ります:
>   - _`swap_flag`_ が 0 の場合、2 つの引数の形式は 1 つの引数の形式と同等です。 バイナリ結果は、文字列引数と同じ順序になります。
>   - _`swap_flag`_ が 1 の場合、戻り値の形式は異なります: time-low 部分と time-high 部分 (それぞれ 16 進数の最初と 3 番目のグループ) がスワップされます。 これにより、より迅速に変化する部分が右側に移動し、結果がインデックス付けされたカラムに格納されている場合はインデックス付けの効率を向上させることができます。
>
> [MySQL 8.0 リファレンスマニュアル より引用](https://dev.mysql.com/doc/refman/8.0/ja/miscellaneous-functions.html#function_uuid)

前述の 0.2.4.1 の `UUID()` 関数で作成した UUID を バイナリ形式にするために使用している。

また、今回は `UUID_TO_BIN()` 関数の中でも `UUID_TO_BIN( string_uuid, swap_flag )` を使用しており、 `swap_flag = 1`である。

##### 0.2.4.3. `NOW()`

> 関数が文字列または数値のどちらのコンテキストで使用されているかに応じて、現在の日時を _`YYYY-MM-DD hh:mm:ss`_ または _`YYYYMMDDhhmmss`_ 形式の値として返します。 値はセッションのタイムゾーンで表されます。
>
> [MySQL 8.0 リファレンスマニュアル より引用](https://dev.mysql.com/doc/refman/8.0/ja/date-and-time-functions.html#function_now)

今回の開発では各テーブルの startAt カラムのデフォルト値として使用している。

#### 0.2.5. Extra について

> 特定のカラムについて使用可能な追加情報。 次の場合、値は空ではありません。
> [MySQL 8.0 リファレンスマニュアル より引用](https://dev.mysql.com/doc/refman/8.0/ja/show-columns.html)

今回の開発では、関数によってカラムのデフォルト値が指定されているものは `DEFAULT_GENERATED` 、自動採番をしているカラムは `auto_increment` になっている。

---

※ 以下、カラムの論理名について "ID" とつくところは "識別子" と読み替えること。

## 1. userTable (ユーザテーブル)

### 1.1. テーブル定義

| Field   | Type            | Null | Key | Default               | Extra             |
| ------- | --------------- | ---- | --- | --------------------- | ----------------- |
| userId  | varbinary(16)   | NO   | PRI | uuid_to_bin(uuid(),1) | DEFAULT_GENERATED |
| carId   | varbinary(16)   | YES  | MUL | NULL                  |                   |
| orderId | bigint unsigned | YES  | MUL | NULL                  |                   |
| startAt | datetime        | NO   |     | now()                 | DEFAULT_GENERATED |
| endAt   | datetime        | YES  |     | NULL                  |                   |

### 1.2. カラムについて

#### 1.2.1. userId ( ユーザ ID )

ユーザを一意に識別するための ID。ユーザを作成するとデフォルトでバイナリ形式のバージョン 1 の UUID のバイト列を並び替えたものが設定される。作成順に昇順となる。

#### 1.2.2. carId ( 車 ID )

車テーブルの車 ID を参照元とする外部キー。ユーザが使用しているまたは使用した車を識別するための ID。

#### 1.2.3. orderId ( 命令 ID )

命令テーブルの命令 ID を参照元とする外部キー。ユーザが実行しているまたは実行した命令を識別するための ID。

#### 1.2.4. startAt ( 開始時刻 )

ユーザを作成した時間。作成時にデフォルトで作成時点の時刻が設定される。他のテーブルの startAt とは関係ない。

#### 1.2.5. endAt ( 終了時刻 )

ユーザを終了した時間。NULL の場合はユーザが利用中である。他のテーブルの endAt とは関係ない。

---

## 2. orderTable (命令テーブル)

### 2.1. テーブル定義

| Field      | Type            | Null | Key | Default | Extra             |
| ---------- | --------------- | ---- | --- | ------- | ----------------- |
| orderId    | bigint unsigned | NO   | PRI | NULL    | auto_increment    |
| nextPoint  | json            | YES  |     | NULL    |                   |
| arrival    | tinyint(1)      | YES  |     | 0       |                   |
| finish     | tinyint(1)      | YES  |     | 0       |                   |
| arrange    | tinyint(1)      | YES  |     | 0       |                   |
| startAt    | datetime        | NO   |     | now()   | DEFAULT_GENERATED |
| endAt      | datetime        | YES  |     | NULL    |                   |
| carToRoute | json            | YES  |     | NULL    |                   |
| route      | json            | YES  |     | NULL    |                   |
| dest       | json            | YES  |     | NULL    |                   |
| junkai     | tinyint(1)      | YES  |     | NULL    |                   |
| pRoute     | bigint unsigned | YES  |     | NULL    |                   |
| pPoint     | bigint unsigned | YES  |     | NULL    |                   |

### 2.2. カラムについて

#### 2.2.1. orderId ( 命令 ID )

実行する経路を一意に識別するための ID。ユーザが経路を作成し、実行するときに作られる。

1 から始まり、作られるたび 1 ずつ増加する。

#### 2.2.2. nextPoint ( 次の地点 )

実行している経路のうち次に向かう地点。車に渡す。

#### 2.2.3. arrival ( 停留所到着フラグ )

実行している経路が停留所に到着しているかを示す。true で到着、false で未到着。

#### 2.2.4. finish ( 目的地到着フラグ )

実行している経路が目的地に到着しているかを示す。true で到着、false で未到着。

#### 2.2.5. arrange ( 手配経路到着フラグ )

割り当てられた車が手配経路の終点に到着したかを示す。true で到着、false で未到着。

#### 2.2.6. startAt ( 開始時刻 )

実行する経路がユーザによって命令された時間。他のテーブルの startAt とは関係ない。

#### 2.2.7. endAt ( 終了時刻 )

実行する経路が終了した時間。NULL の場合は命令実行中。他のテーブルの endAt とは関係ない。

#### 2.2.8. carToRoute ( 手配経路 )

割り当てられた車の割り当て時の現在地( 車テーブルの現在地 )と実行する経路の始点を結んだ経路。

#### 2.2.9. route ( 経路 )

ユーザが命令した経路情報それそのもの。

#### 2.2.10. dest ( 停留所群 )

ユーザが経路を作成したときに停留所に指定した地点群。

#### 2.2.11. junkai ( 巡回フラグ )

ユーザが命令した経路が巡回するかどうか。true で巡回し、false で巡回しない。

#### 2.2.12. pRoute ( ルート進行度 )

実行している経路がルートに対して何ステップ進んだかを示す。0 の場合車が手配経路を走行中で、 1 以降が経路を走行中。

#### 2.2.13. pPoint ( 地点進行度 )

実行している経路がルートの地点に対して何ステップ進んだかを示す。0 の場合、経路の始点から次の点までのどこかにいる。

---

## 3. carTable (車テーブル)

### 3.1. テーブル定義

| Field         | Type             | Null | Key | Default               | Extra             |
| ------------- | ---------------- | ---- | --- | --------------------- | ----------------- |
| carId         | varbinary(16)    | NO   | PRI | uuid_to_bin(uuid(),1) | DEFAULT_GENERATED |
| status        | tinyint unsigned | NO   |     | 1                     |                   |
| sequence      | int unsigned     | NO   |     | NULL                  |                   |
| nowPoint      | json             | YES  |     | NULL                  |                   |
| battery       | tinyint unsigned | YES  |     | 0                     |                   |
| lastAt        | datetime         | NO   |     | now()                 | DEFAULT_GENERATED |
| intervalCount | tinyint unsigned | NO   |     | 0                     |                   |

### 3.2. カラムについて

#### 3.2.1. carId ( 車 ID )

登録された車を一意に識別するための ID。車を作成するとデフォルトでバイナリ形式のバージョン 1 の UUID のバイト列を並び替えたものが設定される。作成順に昇順となる。

#### 3.2.2. status ( 状態 )

車の状態を示す数値。以下の状態がある。

| statusNo. | status                                                                          |
| --------- | ------------------------------------------------------------------------------- |
| 1         | 暇状態 : 車がどのユーザにも割り当てられていない状態                             |
| 2         | 待ち状態 : 車がユーザに割り当てられていて、経路が実行されていない状態           |
| 3         | 実行中・走行状態 : 車がユーザに割り当てられていて、経路を実行中かつ走行中の状態 |
| 4         | 実行中・停止状態 : 車がユーザに割り当てられていて、経路を実行中かつ停止中の状態 |
| 5         | 確認されていない異常状態: 車に異常が発生していて、管理者が認知していない状態    |
| 6         | 確認された異常状態 : 車に異常が発生していて、管理者が認知している状態           |

#### 3.2.3. sequence ( シークエンス番号 )

通信を行ってきた車が、本当にその車かを判断するためのシークエンス番号。1 ~ 4294967295(2^32 -1) までの数値が適当に割り振られる。

#### 3.2.4. nowPoint ( 現在地 )

車が最後に通信してきたときの推定の車の現在地。JSON 形式。

#### 3.2.5. battery ( バッテリー )

車が最後に通信してきた時のバッテリー残量 ( 単位 : [%] )。暇状態から車が割り当てられるとき、バッテリーが 30 未満の車は割り当てられない。

#### 3.2.6. lastAt ( 最終通信時刻 )

車が最後に通信してきた時刻。

#### 3.2.7. intervalCount ( 異常検知カウント )

車が最後に通信してきたときから、規定秒数( 未定義 ) 秒通信がないと 1 増加する。3 になると通信切断による異常状態と判断され、対象の車の状態が 5 になる。

---

## 4. adminTable (管理者テーブル)

### 4.1. テーブル定義

| Field         | Type          | Null | Key | Default | Extra             |
| ------------- | ------------- | ---- | --- | ------- | ----------------- |
| adminName     | varchar(255)  | NO   | PRI | NULL    |                   |
| adminPassHash | varchar(255)  | YES  |     | NULL    |                   |
| adminId       | varbinary(16) | YES  |     | NULL    |                   |
| startAt       | datetime      | NO   |     | now()   | DEFAULT_GENERATED |
| endAt         | datetime      | YES  |     | now()   | DEFAULT_GENERATED |

### 4.2. カラムについて

#### 4.2.1. adminName ( 管理者名 )

管理者の名前。これと管理者パスワードを使用して管理者のログインを行う。

#### 4.2.2. adminPassHash ( 管理者パスワードのハッシュ値 )

管理者のパスワードをハッシュ値にしたもの。これと管理者名を使用して管理者のログインを行う。

#### 4.2.3. adminId ( 管理者 ID )

管理者のログイン処理で発行される ID。バイナリ形式のバージョン 1 の UUID のバイト列を並び替えたものが設定され、ログインごとに値が更新される。これを利用してログイン後の管理者権限が必要な操作を行う。

#### 4.2.4. startAt ( ログイン時刻 )

管理者がログインしたときの時刻。他のテーブルの startAt とは関係ない。

#### 4.2.5. endAt ( ログアウト時刻 )

管理者がログアウトしたときの時刻。該当の管理者が利用中だと NULL になる。

これが NULL の時、ログイン時刻と比較して 1 時間を過ぎると強制的にログアウトされ、その時の時刻が更新される。

他のテーブルの endAt とは関係ない。

---

## 5. passableTable ( 通行可能領域テーブル )

### 5.1. テーブル定義

| Field      | Type            | Null | Key | Default | Extra          |
| ---------- | --------------- | ---- | --- | ------- | -------------- |
| passableId | bigint unsigned | NO   | PRI | NULL    | auto_increment |
| radius     | double          | NO   |     | NULL    |                |
| lat        | double          | NO   |     | NULL    |                |
| lng        | double          | NO   |     | NULL    |                |

### 5.2. カラムについて

#### 5.2.1. passableId ( 通行可能領域 ID )

通行可能領域を一意に識別するための ID。通行可能領域を登録したときに自動で割り振られる。

#### 5.2.2. radius ( 通行可能半径 )

通行可能領域の半径 ( 単位 : [m] )。通行可能緯度と通行可能経度からなる地点からこの半径分の円が通行可能領域となる。

#### 5.2.3. lat ( 通行可能緯度 )

通行可能領域の緯度 ( 単位 : [度] )。通行可能経度と合わせることで通行可能領域の地点となる。

#### 5.2.4. lng ( 通行可能経度 )

通行可能領域の経度 ( 単位 : [度] )。通行可能緯度と合わせることで通行可能領域の地点となる。

---

## 6. routeTable ( 既存経路テーブル )

### 6.1. テーブル定義

| Field     | Type         | Null | Key | Default | Extra |
| --------- | ------------ | ---- | --- | ------- | ----- |
| routeName | varchar(255) | NO   | PRI | NULL    |       |
| route     | json         | NO   |     | NULL    |       |
| dest      | json         | NO   |     | NULL    |       |
| junkai    | tinyint(1)   | NO   |     | NULL    |       |

### 6.2. カラムについて

#### 6.2.1 routeName ( 経路名 )

登録された経路の名前。経路を一意に識別するため名前被りは禁止されている。名前は空白でも可、255 文字まで。

#### 6.2.2 route ( 経路 )

ユーザが作成した経路情報それそのもの。

#### 6.2.3 dest ( 停留所群 )

ユーザが経路を作成したときに停留所に指定した地点群。

#### 6.2.4 junkai ( 巡回フラグ )

ユーザが命令した経路が巡回するかどうか。true で巡回し、false で巡回しない。
